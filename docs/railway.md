# Railway: Volume + авто-деплой без потери данных

Railway делает **build+deploy автоматически при пуше** в подключенную ветку GitHub. Во время деплоя процесс бота перезапускается — это нормально. Чтобы **настройки/расписание не сбрасывались**, SQLite должна лежать в подключенном **Railway Volume**.

## 1) Авто-деплой (GitHub → Railway)
1. Подключите репозиторий GitHub к проекту Railway и выберите ветку для деплоя.
2. Railway будет пересобирать и деплоить сервис при каждом push в эту ветку.
3. Перезапуск процесса на деплое ожидаем: состояние сохраняется не в памяти процесса, а в БД на volume.

## 2) Railway Volume (обязательно для SQLite)
Почему: файловая система контейнера без volume **ephemeral** — при redeploy контейнер пересоздаётся, и локальные файлы (вне volume) пропадают.

Сделайте так:
1. В настройках сервиса бота добавьте **Volume**.
2. Укажите **mount path**: `/app/data`.
3. Убедитесь, что volume именно **подключен к сервису** (а не просто создан в проекте).

## 3) Переменные окружения
Задайте переменные в Railway (Variables):

- `BOT_TOKEN` — токен от BotFather.
- `DB_PATH` — куда писать SQLite.
  - Рекомендуется (SQLAlchemy URL): `sqlite+aiosqlite:////app/data/bot.db`
  - Альтернатива (просто путь; у нас поддержано): `/app/data/bot.db`
- (опционально) `TZ` — часовой пояс, например `Europe/Moscow`.

Важно: `DB_PATH` должен указывать **внутрь `/app/data`**, иначе SQLite окажется в ephemeral FS и потеряется при redeploy.

## 4) Проверка, что всё работает (и пишет в volume)
После деплоя откройте логи сервиса и проверьте строки:
- `Database URL=...`
- `SQLite DB file=/app/data/bot.db (exists=True|False)`

Нормальный сценарий:
1. Первый старт: `exists=False`, затем БД создаётся/миграции применяются.
2. Следующие старты/деплои: `SQLite DB file=/app/data/bot.db (exists=True)`.

Мини-чек “данные переживают redeploy”:
1. В чате задайте расписание (через `/setup`/`/settings`).
2. Сделайте коммит и push в ветку авто-деплоя.
3. Дождитесь деплоя в Railway и перезапуска процесса.
4. Проверьте в чате `/status` (или повторно откройте настройки): расписание **не должно** сброситься.

## 5) Troubleshooting
### Симптом: `permission denied` на `/app/data`
- Проверьте, что volume смонтирован именно в `/app/data` и доступен на запись.
- Попробуйте добавить переменную `RAILWAY_RUN_UID=0` и перезапустить деплой.

### Симптом: после деплоя “расписание не задано”
Почти всегда означает, что бот стартовал с **пустой БД**:
- volume не подключен / смонтирован не в `/app/data`;
- `DB_PATH` указывает **не в volume** (не начинается с `/app/data/...`).

Проверьте в логах, что путь именно `/app/data/bot.db`, и что на повторных деплоях `exists=True`.

## 6) Чек-лист приемки
- Задали расписание в чате.
- Сделали 2–3 деплоя (push → Railway build+deploy).
- Убедились, что после каждого деплоя настройки/расписание на месте (не “слетает”).
